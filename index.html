<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>TextCity Master - Metin Tabanlı Şehir Kurma Oyunu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root {
      --bg: #020617;
      --bg-panel: #020617;
      --border: #1f2937;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.1);
      --accent-strong: #16a34a;
      --danger: #ef4444;
      --danger-soft: rgba(239, 68, 68, 0.1);
      --text: #e5e7eb;
      --text-soft: #9ca3af;
      --warning-soft: rgba(250, 204, 21, 0.1);
      --info-soft: rgba(59, 130, 246, 0.1);
      --info: #3b82f6;
      --success-soft: rgba(34,197,94,0.08);
      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-sm: 8px;
      --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.55);
      --shadow-subtle: 0 12px 30px rgba(0, 0, 0, 0.45);
      --font-sans: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    body {
      background: radial-gradient(circle at top, #1f2937 0, #020617 45%, #020617 100%);
      color: var(--text);
      font-family: var(--font-sans);
      -webkit-font-smoothing: antialiased;
    }

    #app {
      max-width: 1420px;
      margin: 10px auto;
      padding: 8px 10px 14px;
      background: rgba(15,23,42,0.96);
      border-radius: 24px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.35);
      backdrop-filter: blur(18px);
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 14px 10px;
      margin-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }

    .logo {
      display: flex;
      flex-direction: column;
    }

    .logo-main {
      font-weight: 700;
      font-size: 20px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .logo-sub {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: -3px;
    }

    .top-controls {
      display: flex;
      gap: 6px;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      background: radial-gradient(circle at top left, rgba(148,163,184,0.25), rgba(15,23,42,0.9));
      color: var(--text);
      padding: 4px 13px;
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s ease-out;
      white-space: nowrap;
    }

    .btn:hover {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(34,197,94,0.3);
      transform: translateY(-1px);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      border-color: transparent;
      color: #0b1120;
      font-weight: 600;
    }

    .btn-primary:hover {
      box-shadow: 0 0 0 1px rgba(34,197,94,0.2),
                  0 12px 25px rgba(34,197,94,0.35);
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--danger), #b91c1c);
      border-color: transparent;
      color: #fef2f2;
      font-weight: 600;
    }

    .btn-danger:hover {
      box-shadow: 0 0 0 1px rgba(239,68,68,0.25),
                  0 12px 25px rgba(239,68,68,0.35);
    }

    .btn-ghost {
      background: transparent;
      border-color: rgba(148,163,184,0.35);
      color: var(--text-soft);
      font-size: 11px;
      padding-inline: 10px;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(280px, 420px) minmax(320px, 520px) minmax(260px, 360px);
      gap: 10px;
    }

    .panel {
      background: radial-gradient(circle at top, rgba(15,23,42,0.96), rgba(2,6,23,0.98));
      border-radius: var(--radius-lg);
      border: 1px solid rgba(31,41,55,0.95);
      box-shadow: var(--shadow-subtle);
      display: flex;
      flex-direction: column;
      padding: 8px 10px 10px;
      min-height: 420px;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      padding-bottom: 4px;
      border-bottom: 1px solid rgba(30,64,175,0.35);
    }

    .panel-header h2 {
      font-size: 14px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text-soft);
      margin: 0;
    }

    .turn-info {
      display: flex;
      gap: 10px;
      font-size: 11px;
      color: var(--text-soft);
    }

    /* HARİTA */
    .map-wrapper {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .map-grid {
      border-radius: var(--radius-md);
      border: 1px solid rgba(55,65,81,0.9);
      overflow: hidden;
      background: radial-gradient(circle at top, #020617, #020617 55%, #000 100%);
      box-shadow: inset 0 0 0 1px rgba(15,23,42,0.9);
    }

    .map-row {
      display: grid;
      grid-template-columns: repeat(8, minmax(0, 1fr));
    }

    .map-cell {
      border: 1px solid rgba(31,41,55,0.8);
      padding: 2px;
      font-size: 10px;
      text-align: center;
      cursor: pointer;
      min-height: 40px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      transition: background 0.1s ease, transform 0.1s ease;
    }

    .map-cell:hover {
      transform: translateY(-1px);
      box-shadow: 0 0 0 1px rgba(34,197,94,0.4);
    }

    .map-cell.selected {
      outline: 1px solid var(--accent);
      box-shadow: inset 0 0 0 2px rgba(34,197,94,0.7);
    }

    .cell-label {
      font-size: 9px;
      color: var(--text-soft);
      margin-bottom: 1px;
    }

    .cell-zone {
      font-size: 11px;
      font-weight: 600;
      padding: 2px 4px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,0.8);
    }

    .zone-empty       { background:#020617; color:#4b5563; border-color:#111827; }
    .zone-residential { background:#064e3b; color:#bbf7d0; }
    .zone-commercial  { background:#0f172a; color:#bae6fd; border-color:#0369a1; }
    .zone-industrial  { background:#451a03; color:#fed7aa; border-color:#ea580c; }
    .zone-agriculture { background:#3f6212; color:#ecfccb; border-color:#84cc16; }
    .zone-forest      { background:#022c22; color:#bbf7d0; border-color:#16a34a; }
    .zone-park        { background:#014451; color:#a5f3fc; border-color:#0d9488; }
    .zone-utility     { background:#111827; color:#e5e7eb; border-color:#9ca3af; }

    .turn-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 6px;
      gap: 6px;
    }

    .turn-summary {
      font-size: 10px;
      color: var(--text-soft);
    }

    /* Stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px;
      margin-bottom: 8px;
    }

    .stat-card {
      background: radial-gradient(circle at top, rgba(15,23,42,0.9), rgba(15,23,42,0.98));
      border-radius: var(--radius-md);
      border: 1px solid rgba(31,41,55,0.9);
      padding: 6px 8px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.5);
    }

    .stat-label {
      font-size: 11px;
      color: var(--text-soft);
    }

    .stat-value {
      font-size: 14px;
      margin-top: 4px;
    }

    .economy-section {
      margin-top: 4px;
      padding-top: 6px;
      border-top: 1px dashed rgba(55,65,81,0.9);
    }

    .economy-section h3,
    .policies-section h3,
    .infrastructure-section h3 {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-soft);
      margin: 0 0 5px;
    }

    .economy-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 3px 10px;
      margin-bottom: 8px;
      font-size: 11px;
    }

    .economy-item {
      display: flex;
      justify-content: space-between;
      color: var(--text-soft);
    }

    .tax-controls {
      border-radius: var(--radius-md);
      border: 1px solid rgba(31,41,55,0.9);
      padding: 6px 8px;
      background: radial-gradient(circle at top, rgba(15,23,42,0.95), rgba(15,23,42,1));
      font-size: 11px;
    }

    .tax-controls h4 {
      margin: 0 0 4px;
      color: var(--text-soft);
    }

    .tax-row {
      display: grid;
      grid-template-columns: 1.3fr 2.2fr 0.5fr;
      align-items: center;
      gap: 4px;
      margin-bottom: 2px;
    }

    .tax-row input[type="range"] {
      width: 100%;
    }

    .tax-row span:last-child {
      text-align: right;
    }

    .policies-section,
    .infrastructure-section {
      margin-top: 8px;
      padding-top: 6px;
      border-top: 1px dashed rgba(55,65,81,0.9);
    }

    .policies-grid,
    .infra-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 5px;
    }

    .policy-card,
    .infra-card {
      border-radius: var(--radius-md);
      border: 1px solid rgba(55,65,81,0.9);
      padding: 5px 6px;
      font-size: 11px;
      background: radial-gradient(circle at top, rgba(15,23,42,0.95), rgba(15,23,42,0.98));
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .policy-card:hover {
      border-color: rgba(34,197,94,0.7);
    }

    .infra-card:hover {
      border-color: rgba(59,130,246,0.7);
    }

    .policy-title,
    .infra-title {
      font-weight: 600;
    }

    .policy-desc,
    .infra-desc {
      color: var(--text-soft);
      font-size: 10px;
    }

    .policy-status,
    .infra-status {
      font-size: 10px;
    }

    .policy-active {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(34,197,94,0.4);
    }

    .infra-active {
      border-color: var(--info);
      box-shadow: 0 0 0 1px rgba(59,130,246,0.4);
    }

    /* Seçili kare */
    .tile-details {
      background: radial-gradient(circle at top, rgba(15,23,42,0.9), rgba(15,23,42,1));
      border-radius: var(--radius-md);
      border: 1px solid rgba(31,41,55,0.9);
      padding: 8px 9px;
      font-size: 12px;
      min-height: 180px;
      margin-bottom: 8px;
    }

    .tile-details h3 {
      font-size: 13px;
      margin: 0 0 4px;
    }

    .tile-meta {
      font-size: 11px;
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    .tile-stats {
      font-size: 11px;
      margin: 2px 0;
    }

    .tile-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 6px;
    }

    .tile-actions .btn {
      font-size: 10px;
      padding: 3px 8px;
    }

    /* Log */
    .log-header {
      margin-top: 4px;
    }

    .log-container {
      flex: 1;
      border-radius: var(--radius-md);
      border: 1px solid rgba(31,41,55,0.9);
      padding: 6px 8px;
      background: radial-gradient(circle at top, rgba(15,23,42,0.96), rgba(15,23,42,0.99));
      font-size: 11px;
      overflow-y: auto;
      max-height: 320px;
    }

    .log-entry {
      margin-bottom: 4px;
      padding: 3px 5px;
      border-radius: 6px;
      line-height: 1.3;
    }

    .log-info    { background: var(--info-soft); }
    .log-good    { background: var(--success-soft); }
    .log-bad     { background: var(--danger-soft); }
    .log-neutral { background: rgba(31,41,55,0.9); }
    .log-warning { background: var(--warning-soft); }

    @media (max-width: 1150px) {
      .layout {
        grid-template-columns: 1fr 1fr;
        grid-template-rows: auto auto;
      }
      .panel-details {
        grid-column: span 2;
      }
    }

    @media (max-width: 850px) {
      #app {
        margin: 0;
        border-radius: 0;
      }
      .layout {
        grid-template-columns: 1fr;
      }
      .panel {
        min-height: auto;
      }
      .log-container {
        max-height: 240px;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <header class="top-bar">
      <div class="logo">
        <span class="logo-main">TextCity</span>
        <span class="logo-sub">Master Edition</span>
      </div>
      <div class="top-controls">
        <button id="btnNewGame" class="btn btn-danger">Yeni Oyun</button>
        <button id="btnSave" class="btn">Kaydet</button>
        <button id="btnLoad" class="btn">Yükle</button>
        <button id="btnReset" class="btn">Sıfırla</button>
      </div>
    </header>

    <main class="layout">
      <!-- SOL PANEL: HARİTA -->
      <section class="panel panel-map">
        <div class="panel-header">
          <h2>Şehir Haritası</h2>
          <div class="turn-info">
            <span>Gün: <span id="dayDisplay">1</span></span>
            <span>Mevsim: <span id="seasonDisplay">İlkbahar</span></span>
            <span>Hava: <span id="weatherDisplay">Güneşli</span></span>
          </div>
        </div>

        <div class="map-wrapper">
          <div id="mapContainer" class="map-grid">
            <!-- JS doldurur -->
          </div>

          <div class="turn-controls">
            <button id="btnEndTurn" class="btn btn-primary">Turu Bitir</button>
            <div class="turn-summary" id="turnSummary">
              Son Tur: Gelir 0 | Gider 0 | Nüfus Δ 0 | Mutluluk Δ 0
            </div>
          </div>
        </div>
      </section>

      <!-- ORTA PANEL: ŞEHİR DURUMU -->
      <section class="panel panel-stats">
        <div class="panel-header">
          <h2>Şehir Durumu</h2>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Nakit</div>
            <div class="stat-value" id="moneyDisplay">₺ 0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Nüfus</div>
            <div class="stat-value" id="populationDisplay">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">İstihdam</div>
            <div class="stat-value" id="employmentDisplay">0% (işsiz 0)</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Mutluluk</div>
            <div class="stat-value" id="happinessDisplay">50%</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Çevre</div>
            <div class="stat-value" id="environmentDisplay">Dengeli</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Trafik</div>
            <div class="stat-value" id="trafficDisplay">Akıcı</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Enerji</div>
            <div class="stat-value" id="powerDisplay">0 / 0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Su</div>
            <div class="stat-value" id="waterDisplay">0 / 0</div>
          </div>
        </div>

        <div class="economy-section">
          <h3>Ekonomi</h3>
          <div class="economy-grid">
            <div class="economy-item">
              <span>Günlük Vergi:</span>
              <span id="taxIncomeDisplay">0</span>
            </div>
            <div class="economy-item">
              <span>Günlük Üretim:</span>
              <span id="productionIncomeDisplay">0</span>
            </div>
            <div class="economy-item">
              <span>Bakım Gideri:</span>
              <span id="maintenanceCostDisplay">0</span>
            </div>
            <div class="economy-item">
              <span>Net:</span>
              <span id="netIncomeDisplay">0</span>
            </div>
          </div>

          <div class="tax-controls">
            <h4>Vergi Oranları</h4>
            <div class="tax-row">
              <label>Konut %</label>
              <input type="range" id="taxResidential" min="1" max="25" value="10">
              <span id="taxResidentialValue">10</span>
            </div>
            <div class="tax-row">
              <label>Ticari %</label>
              <input type="range" id="taxCommercial" min="1" max="30" value="12">
              <span id="taxCommercialValue">12</span>
            </div>
            <div class="tax-row">
              <label>Sanayi %</label>
              <input type="range" id="taxIndustrial" min="1" max="35" value="15">
              <span id="taxIndustrialValue">15</span>
            </div>
          </div>
        </div>

        <div class="policies-section">
          <h3>Politikalar</h3>
          <div id="policiesContainer" class="policies-grid"></div>
        </div>

        <div class="infrastructure-section">
          <h3>Altyapı / Özel Binalar</h3>
          <div id="infrastructureContainer" class="infra-grid"></div>
        </div>
      </section>

      <!-- SAĞ PANEL: SEÇİLİ ALAN + LOG -->
      <section class="panel panel-details">
        <div class="panel-header">
          <h2>Seçili Alan</h2>
        </div>

        <div id="selectedTileDetails" class="tile-details">
          Haritadan bir kareye tıkla.
        </div>

        <div class="panel-header log-header">
          <h2>Olay Günlüğü</h2>
          <button id="btnClearLog" class="btn btn-ghost">Temizle</button>
        </div>

        <div id="logContainer" class="log-container"></div>
      </section>
    </main>
  </div>

  <script>
    const MAP_WIDTH = 8;
    const MAP_HEIGHT = 6;
    const STORAGE_KEY = "TextCityMasterSave_v1";
    const SEASONS = ["İlkbahar", "Yaz", "Sonbahar", "Kış"];

    const ZONES = {
      empty:  { id:"empty", name:"Boş",       type:"none",        baseHousing:0,  baseJobs:0,  baseTax:0,  baseProduction:0,  basePollution:0,  maintenance:0 },
      residential:{ id:"residential", name:"Konut",     type:"residential", baseHousing:60, baseJobs:5,  baseTax:20, baseProduction:0,  basePollution:2,  maintenance:8 },
      commercial: { id:"commercial",  name:"Ticari",    type:"commercial",  baseHousing:0,  baseJobs:25, baseTax:35, baseProduction:10, basePollution:4,  maintenance:10 },
      industrial: { id:"industrial",  name:"Sanayi",    type:"industrial",  baseHousing:0,  baseJobs:40, baseTax:45, baseProduction:35, basePollution:10, maintenance:14 },
      agriculture:{ id:"agriculture", name:"Tarım",     type:"agriculture", baseHousing:0,  baseJobs:15, baseTax:15, baseProduction:40, basePollution:-2, maintenance:6 },
      forest:     { id:"forest",      name:"Orman",     type:"forest",      baseHousing:0,  baseJobs:3,  baseTax:5,  baseProduction:5,  basePollution:-10,maintenance:4 },
      park:       { id:"park",        name:"Park",      type:"park",        baseHousing:0,  baseJobs:5,  baseTax:2,  baseProduction:0,  basePollution:-6, maintenance:5 },
      utility:    { id:"utility",     name:"Altyapı",   type:"utility",     baseHousing:0,  baseJobs:10, baseTax:8,  baseProduction:0,  basePollution:4,  maintenance:12 }
    };

    const WEATHER_TYPES = [
      { id:"sunny",   name:"Güneşli", moodDelta:+2, productionMod:1.0,  disasterRiskMod:1.0 },
      { id:"rain",    name:"Yağmurlu",moodDelta:0, productionMod:1.05, disasterRiskMod:1.1 },
      { id:"storm",   name:"Fırtına", moodDelta:-4,productionMod:0.8,  disasterRiskMod:1.4 },
      { id:"drought", name:"Kuraklık",moodDelta:-3,productionMod:0.7,  disasterRiskMod:1.3 },
      { id:"snow",    name:"Karlı",   moodDelta:-1,productionMod:0.9,  disasterRiskMod:1.2 }
    ];

    const DISASTERS = [
      { id:"fire",      name:"Büyük Yangın",     baseChance:0.02,  tilesHit:2, moneyLoss:2000, moodDelta:-8 },
      { id:"flood",     name:"Sel Baskını",      baseChance:0.015, tilesHit:2, moneyLoss:2500, moodDelta:-6 },
      { id:"earthquake",name:"Deprem",           baseChance:0.007, tilesHit:3, moneyLoss:5000, moodDelta:-12 },
      { id:"epidemic",  name:"Salgın Hastalık",  baseChance:0.012, tilesHit:0, moneyLoss:1500, moodDelta:-10 },
      { id:"riot",      name:"Toplumsal Olay",   baseChance:0.01,  tilesHit:0, moneyLoss:1000, moodDelta:-9 }
    ];

    const POLICIES = {
      greenCity: {
        id:"greenCity",
        name:"Yeşil Şehir",
        desc:"Orman ve park etkisi artar, sanayi kirliliği cezalandırılır.",
        upkeep:150,
        modifiers:{ pollutionGlobal:-4, happinessGlobal:+3, industrialPollutionExtra:+3 }
      },
      industryBoost: {
        id:"industryBoost",
        name:"Sanayi Teşviki",
        desc:"Sanayi üretimi ve vergi artar, mutluluk düşer.",
        upkeep:200,
        modifiers:{ industrialProductionMod:1.25, industrialTaxMod:1.2, happinessGlobal:-4 }
      },
      lowTaxes: {
        id:"lowTaxes",
        name:"Düşük Vergi Sözü",
        desc:"Mutluluk artar, vergi geliri hafif azalır.",
        upkeep:0,
        modifiers:{ taxModGlobal:0.9, happinessGlobal:+4 }
      },
      highServices: {
        id:"highServices",
        name:"Güçlü Belediye Hizmetleri",
        desc:"Hizmet kalitesi artar, bakım masrafı yükselir.",
        upkeep:350,
        modifiers:{ maintenanceModGlobal:1.25, happinessGlobal:+5 }
      },
      trafficPolicy: {
        id:"trafficPolicy",
        name:"Toplu Taşıma Atağı",
        desc:"Trafik yükü azalır, masraf artar.",
        upkeep:180,
        modifiers:{ trafficGlobal:-10 }
      }
    };

    const INFRASTRUCTURE = {
      hospital: {
        id:"hospital",
        name:"Şehir Hastanesi",
        desc:"Sağlık ve mutluluğu artırır, salgın riskini azaltır.",
        buildCost:12000, upkeep:260,
        modifiers:{ happinessGlobal:+5, epidemicRiskMod:0.5 }
      },
      school: {
        id:"school",
        name:"Eğitim Kampüsü",
        desc:"Uzun vadede üretim ve vergi verimliliğini artırır.",
        buildCost:9000, upkeep:220,
        modifiers:{ productionModGlobal:1.08, taxModGlobal:1.04 }
      },
      fireStation: {
        id:"fireStation",
        name:"İtfaiye Merkezi",
        desc:"Yangın hasarını ve riskini azaltır.",
        buildCost:8000, upkeep:180,
        modifiers:{ fireRiskMod:0.5 }
      },
      floodBarrier: {
        id:"floodBarrier",
        name:"Sel Setleri",
        desc:"Sel ihtimalini ciddi azaltır.",
        buildCost:7000, upkeep:140,
        modifiers:{ floodRiskMod:0.4 }
      },
      powerPlant: {
        id:"powerPlant",
        name:"Ana Güç Santrali",
        desc:"Enerji kapasitesini yükseltir, kirliliği arttırır.",
        buildCost:11000, upkeep:260,
        modifiers:{ powerCapacity:+400, pollutionGlobal:+6 }
      },
      waterPlant: {
        id:"waterPlant",
        name:"Su Arıtma Tesisi",
        desc:"Su kapasitesini arttırır, kirliliği azaltır.",
        buildCost:9500, upkeep:220,
        modifiers:{ waterCapacity:+350, pollutionGlobal:-5 }
      }
    };

    let state = null;
    let selectedTile = null;
    let currentWeather = WEATHER_TYPES[0];
    let currentSeasonIndex = 0;

    const rand = () => Math.random();
    const randInt = (min,max)=>Math.floor(Math.random()*(max-min+1))+min;
    const choice = arr => arr[Math.floor(Math.random()*arr.length)];
    const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

    const logContainer = () => document.getElementById("logContainer");

    function addLog(message,type="info"){
      const c = logContainer();
      if(!c) return;
      const div = document.createElement("div");
      div.classList.add("log-entry");
      if(type==="good") div.classList.add("log-good");
      else if(type==="bad") div.classList.add("log-bad");
      else if(type==="warning") div.classList.add("log-warning");
      else if(type==="neutral") div.classList.add("log-neutral");
      else div.classList.add("log-info");
      div.textContent = message;
      c.prepend(div);
      while(c.children.length>80){ c.removeChild(c.lastChild); }
    }

    function createEmptyMap(){
      const map=[];
      for(let y=0;y<MAP_HEIGHT;y++){
        const row=[];
        for(let x=0;x<MAP_WIDTH;x++){
          row.push({x,y,zone:"empty",level:0,pollution:0,localHappiness:0});
        }
        map.push(row);
      }
      return map;
    }

    function defaultState(){
      return{
        day:1,
        money:50000,
        population:0,
        employmentRate:0,
        unemployed:0,
        happiness:50,
        environment:0,
        trafficLoad:10,
        powerUsage:0,
        waterUsage:0,
        powerCapacity:200,
        waterCapacity:200,
        taxes:{ residential:10, commercial:12, industrial:15 },
        lastTurn:{ taxIncome:0, productionIncome:0, maintenanceCost:0, netIncome:0, populationDelta:0, happinessDelta:0 },
        map:createEmptyMap(),
        policiesActive:{},
        infrastructureBuilt:{},
        statsHistory:[]
      };
    }

    function saveGame(){
      try{
        localStorage.setItem(STORAGE_KEY,JSON.stringify(state));
        addLog("Oyun kaydedildi.","good");
      }catch(e){
        console.error(e);
        addLog("Oyun kaydı sırasında hata oluştu.","bad");
      }
    }

    function loadGame(){
      try{
        const data = localStorage.getItem(STORAGE_KEY);
        if(!data){ addLog("Kayıtlı oyun bulunamadı.","warning"); return; }
        const parsed = JSON.parse(data);
        state = parsed;
        if(!state.map) state.map=createEmptyMap();
        if(!state.taxes) state.taxes={ residential:10, commercial:12, industrial:15 };
        if(!state.lastTurn) state.lastTurn={ taxIncome:0, productionIncome:0, maintenanceCost:0, netIncome:0, populationDelta:0, happinessDelta:0 };
        if(!state.policiesActive) state.policiesActive={};
        if(!state.infrastructureBuilt) state.infrastructureBuilt={};
        if(!state.statsHistory) state.statsHistory=[];
        addLog("Kayıtlı oyun yüklendi.","good");
        renderAll();
      }catch(e){
        console.error(e);
        addLog("Kayıt yüklenirken hata oluştu.","bad");
      }
    }

    function resetSave(){
      localStorage.removeItem(STORAGE_KEY);
      addLog("Kayıt dosyası silindi.","warning");
    }

    function renderMap(){
      const container=document.getElementById("mapContainer");
      container.innerHTML="";
      for(let y=0;y<MAP_HEIGHT;y++){
        const rowDiv=document.createElement("div");
        rowDiv.classList.add("map-row");
        for(let x=0;x<MAP_WIDTH;x++){
          const tile=state.map[y][x];
          const cell=document.createElement("div");
          cell.classList.add("map-cell");
          if(selectedTile && selectedTile.x===x && selectedTile.y===y){
            cell.classList.add("selected");
          }
          const label=document.createElement("div");
          label.classList.add("cell-label");
          label.textContent=String.fromCharCode(65+y)+(x+1);

          const zoneDiv=document.createElement("div");
          zoneDiv.classList.add("cell-zone");
          const zone = ZONES[tile.zone] || ZONES.empty;
          let short = "–";
          if(zone.id==="residential") short="R";
          else if(zone.id==="commercial") short="C";
          else if(zone.id==="industrial") short="I";
          else if(zone.id==="agriculture") short="A";
          else if(zone.id==="forest") short="F";
          else if(zone.id==="park") short="P";
          else if(zone.id==="utility") short="U";
          zoneDiv.textContent = short + (tile.zone!=="empty" ? " Lv"+tile.level : "");
          zoneDiv.classList.add("zone-"+zone.id);

          cell.appendChild(label);
          cell.appendChild(zoneDiv);

          cell.addEventListener("click",()=>{
            selectedTile={x,y};
            renderTileDetails();
            renderMap();
          });

          rowDiv.appendChild(cell);
        }
        container.appendChild(rowDiv);
      }
    }

    function countZone(zoneId){
      let c=0;
      for(let y=0;y<MAP_HEIGHT;y++){
        for(let x=0;x<MAP_WIDTH;x++){
          if(state.map[y][x].zone===zoneId) c++;
        }
      }
      return c;
    }

    function renderTileDetails(){
      const container=document.getElementById("selectedTileDetails");
      if(!selectedTile){
        container.textContent="Haritadan bir kareye tıkla.";
        return;
      }
      const tile=state.map[selectedTile.y][selectedTile.x];
      const zone=ZONES[tile.zone] || ZONES.empty;
      const housing=zone.baseHousing*(1+tile.level*0.4);
      const jobs=zone.baseJobs*(1+tile.level*0.5);
      const prod=zone.baseProduction*(1+tile.level*0.6);
      const pollution=zone.basePollution+tile.level*2;

      container.innerHTML=`
        <h3>Kare: ${String.fromCharCode(65+tile.y)}${tile.x+1}</h3>
        <div class="tile-meta">
          Bölge: <strong>${zone.name}</strong> ${tile.zone!=="empty" ? "(Seviye "+tile.level+")" : ""}
        </div>
        <div class="tile-stats">
          Barınma Kapasitesi: <strong>${housing.toFixed(0)}</strong><br>
          İş Kapasitesi: <strong>${jobs.toFixed(0)}</strong><br>
          Günlük Üretim: <strong>${prod.toFixed(0)}</strong><br>
          Yerel Kirlilik: <strong>${pollution}</strong>
        </div>
        <div class="tile-stats">
          Toplam Bölge Sayısı —
          Konut ${countZone("residential")},
          Ticari ${countZone("commercial")},
          Sanayi ${countZone("industrial")},
          Tarım ${countZone("agriculture")},
          Orman ${countZone("forest")}
        </div>
        <div class="tile-actions">
          ${tile.zone!=="residential"?`<button class="btn" data-action="setZone" data-zone="residential">Konut</button>`:""}
          ${tile.zone!=="commercial"?`<button class="btn" data-action="setZone" data-zone="commercial">Ticari</button>`:""}
          ${tile.zone!=="industrial"?`<button class="btn" data-action="setZone" data-zone="industrial">Sanayi</button>`:""}
          ${tile.zone!=="agriculture"?`<button class="btn" data-action="setZone" data-zone="agriculture">Tarım</button>`:""}
          ${tile.zone!=="forest"?`<button class="btn" data-action="setZone" data-zone="forest">Orman</button>`:""}
          ${tile.zone!=="park"?`<button class="btn" data-action="setZone" data-zone="park">Park</button>`:""}
          ${tile.zone!=="utility"?`<button class="btn" data-action="setZone" data-zone="utility">Altyapı</button>`:""}
          ${tile.zone!=="empty"?`<button class="btn btn-ghost" data-action="bulldoze">Boşalt</button>`:""}
          ${tile.zone!=="empty"?`<button class="btn btn-primary" data-action="upgrade">Yükselt (₺${1000+tile.level*800})</button>`:""}
        </div>
      `;

      container.querySelectorAll("button[data-action]").forEach(btn=>{
        btn.addEventListener("click",()=>{
          const action=btn.getAttribute("data-action");
          if(action==="setZone"){
            setTileZone(tile.x,tile.y,btn.getAttribute("data-zone"));
          }else if(action==="upgrade"){
            upgradeTile(tile.x,tile.y);
          }else if(action==="bulldoze"){
            bulldozeTile(tile.x,tile.y);
          }
        });
      });
    }

    function setTileZone(x,y,zoneId){
      const tile=state.map[y][x];
      const zone=ZONES[zoneId];
      if(!zone) return;
      const cost=500;
      if(state.money<cost){
        addLog("Yetersiz bakiye: Bölge atamak için en az ₺"+cost+" gerekir.","bad");
        return;
      }
      state.money-=cost;
      tile.zone=zoneId;
      tile.level=0; tile.pollution=0; tile.localHappiness=0;
      addLog(`${String.fromCharCode(65+y)}${x+1} karası ${zone.name} bölgesine dönüştürüldü. (₺${cost})`,"info");
      renderAll();
    }

    function upgradeTile(x,y){
      const tile=state.map[y][x];
      if(tile.zone==="empty") return;
      if(tile.level>=3){
        addLog("Bu alan zaten azami seviyede.","warning");
        return;
      }
      const cost=1000+tile.level*800;
      if(state.money<cost){
        addLog("Yetersiz bakiye: Yükseltme için ₺"+cost+" gerekir.","bad");
        return;
      }
      state.money-=cost;
      tile.level++;
      addLog(`${String.fromCharCode(65+y)}${x+1} alanı seviye ${tile.level} oldu. (₺${cost})`,"good");
      renderAll();
    }

    function bulldozeTile(x,y){
      const tile=state.map[y][x];
      if(tile.zone==="empty") return;
      tile.zone="empty";
      tile.level=0;
      tile.pollution=0;
      tile.localHappiness=0;
      addLog(`${String.fromCharCode(65+y)}${x+1} alanı boşaltıldı.`,"neutral");
      renderAll();
    }

    function renderStats(){
      document.getElementById("dayDisplay").textContent=state.day;
      document.getElementById("seasonDisplay").textContent=SEASONS[currentSeasonIndex];
      document.getElementById("weatherDisplay").textContent=currentWeather.name;

      document.getElementById("moneyDisplay").textContent="₺ "+state.money.toLocaleString("tr-TR");
      document.getElementById("populationDisplay").textContent=state.population.toLocaleString("tr-TR");
      document.getElementById("employmentDisplay").textContent=
        `${state.employmentRate.toFixed(1)}% (işsiz ${state.unemployed.toLocaleString("tr-TR")})`;
      document.getElementById("happinessDisplay").textContent=`${state.happiness.toFixed(1)}%`;

      let envLabel="Dengeli";
      if(state.environment<-20) envLabel="Ağır Kirli";
      else if(state.environment<0) envLabel="Kirli";
      else if(state.environment>20) envLabel="Çok Temiz";
      else if(state.environment>0) envLabel="Temiz";
      document.getElementById("environmentDisplay").textContent=envLabel;

      let trafficLabel="Akıcı";
      if(state.trafficLoad>70) trafficLabel="Kilit";
      else if(state.trafficLoad>40) trafficLabel="Yoğun";
      else if(state.trafficLoad>20) trafficLabel="Orta";
      document.getElementById("trafficDisplay").textContent=trafficLabel;

      document.getElementById("powerDisplay").textContent=
        `${state.powerUsage.toFixed(0)} / ${state.powerCapacity.toFixed(0)}`;
      document.getElementById("waterDisplay").textContent=
        `${state.waterUsage.toFixed(0)} / ${state.waterCapacity.toFixed(0)}`;

      const t=state.lastTurn;
      document.getElementById("taxIncomeDisplay").textContent="₺ "+t.taxIncome.toFixed(0);
      document.getElementById("productionIncomeDisplay").textContent="₺ "+t.productionIncome.toFixed(0);
      document.getElementById("maintenanceCostDisplay").textContent="₺ "+t.maintenanceCost.toFixed(0);
      document.getElementById("netIncomeDisplay").textContent="₺ "+t.netIncome.toFixed(0);

      const tr=document.getElementById("taxResidential");
      const tc=document.getElementById("taxCommercial");
      const ti=document.getElementById("taxIndustrial");
      tr.value=state.taxes.residential;
      tc.value=state.taxes.commercial;
      ti.value=state.taxes.industrial;
      document.getElementById("taxResidentialValue").textContent=state.taxes.residential;
      document.getElementById("taxCommercialValue").textContent=state.taxes.commercial;
      document.getElementById("taxIndustrialValue").textContent=state.taxes.industrial;

      document.getElementById("turnSummary").textContent =
        `Son Tur: Gelir ₺${(t.taxIncome+t.productionIncome).toFixed(0)} | Gider ₺${t.maintenanceCost.toFixed(0)} | Net ₺${t.netIncome.toFixed(0)} | Nüfus Δ ${t.populationDelta.toFixed(0)} | Mutluluk Δ ${t.happinessDelta.toFixed(1)}`;
    }

    function renderPolicies(){
      const container=document.getElementById("policiesContainer");
      container.innerHTML="";
      for(const key in POLICIES){
        const p=POLICIES[key];
        const card=document.createElement("div");
        card.classList.add("policy-card");
        if(state.policiesActive[p.id]) card.classList.add("policy-active");
        card.innerHTML=`
          <div class="policy-title">${p.name}</div>
          <div class="policy-desc">${p.desc}</div>
          <div class="policy-status">
            Günlük Maliyet: ₺${p.upkeep} | Durum: <strong>${state.policiesActive[p.id]?"Aktif":"Pasif"}</strong>
          </div>`;
        card.addEventListener("click",()=>togglePolicy(p.id));
        container.appendChild(card);
      }
    }

    function renderInfrastructure(){
      const container=document.getElementById("infrastructureContainer");
      container.innerHTML="";
      for(const key in INFRASTRUCTURE){
        const i=INFRASTRUCTURE[key];
        const active=!!state.infrastructureBuilt[i.id];
        const card=document.createElement("div");
        card.classList.add("infra-card");
        if(active) card.classList.add("infra-active");
        card.innerHTML=`
          <div class="infra-title">${i.name}</div>
          <div class="infra-desc">${i.desc}</div>
          <div class="infra-status">
            Yapım: ₺${i.buildCost} | Günlük: ₺${i.upkeep} | <strong>${active?"Kurulu":"Kurulmamış"}</strong>
          </div>`;
        card.addEventListener("click",()=>buildInfrastructure(i.id));
        container.appendChild(card);
      }
    }

    function togglePolicy(id){
      const p=POLICIES[id]; if(!p) return;
      if(state.policiesActive[id]){
        state.policiesActive[id]=false;
        addLog(`${p.name} politikası devre dışı bırakıldı.`,"warning");
      }else{
        state.policiesActive[id]=true;
        addLog(`${p.name} politikası devreye alındı.`,"good");
      }
      renderAll();
    }

    function buildInfrastructure(id){
      const infra=INFRASTRUCTURE[id]; if(!infra) return;
      if(state.infrastructureBuilt[id]){
        addLog(`${infra.name} zaten kurulmuş.`,"warning");
        return;
      }
      if(state.money<infra.buildCost){
        addLog(`Yetersiz bakiye: ${infra.name} için ₺${infra.buildCost} gerekir.`,"bad");
        return;
      }
      state.money-=infra.buildCost;
      state.infrastructureBuilt[id]=true;
      addLog(`${infra.name} inşa edildi. Şehir kapasiteniz gelişti.`,"good");
      applyInfrastructureStaticEffects();
      renderAll();
    }

    function applyInfrastructureStaticEffects(){
      let basePower=200;
      let baseWater=200;
      let pollution=0;
      for(const id in INFRASTRUCTURE){
        if(!state.infrastructureBuilt[id]) continue;
        const inf=INFRASTRUCTURE[id];
        const m=inf.modifiers || {};
        if(m.powerCapacity) basePower+=m.powerCapacity;
        if(m.waterCapacity) baseWater+=m.waterCapacity;
        if(m.pollutionGlobal) pollution+=m.pollutionGlobal;
      }
      state.powerCapacity=basePower;
      state.waterCapacity=baseWater;
      state.environment+=pollution;
    }

    function aggregatePolicyModifiers(){
      const mod={
        pollutionGlobal:0,happinessGlobal:0,industrialPollutionExtra:0,
        industrialProductionMod:1.0,industrialTaxMod:1.0,
        taxModGlobal:1.0,maintenanceModGlobal:1.0,
        trafficGlobal:0,productionModGlobal:1.0,
        fireRiskMod:1.0,floodRiskMod:1.0,epidemicRiskMod:1.0
      };
      for(const id in POLICIES){
        if(!state.policiesActive[id]) continue;
        const p=POLICIES[id];
        const m=p.modifiers||{};
        for(const k in m){
          if(typeof mod[k]==="number"){
            if(k.endsWith("Mod")){
              mod[k]*=m[k];
            }else{
              mod[k]+=m[k];
            }
          }
        }
      }
      for(const id in INFRASTRUCTURE){
        if(!state.infrastructureBuilt[id]) continue;
        const inf=INFRASTRUCTURE[id];
        const m=inf.modifiers||{};
        if(m.fireRiskMod) mod.fireRiskMod*=m.fireRiskMod;
        if(m.floodRiskMod) mod.floodRiskMod*=m.floodRiskMod;
        if(m.epidemicRiskMod) mod.epidemicRiskMod*=m.epidemicRiskMod;
        if(m.productionModGlobal) mod.productionModGlobal*=m.productionModGlobal;
        if(m.taxModGlobal) mod.taxModGlobal*=m.taxModGlobal;
        if(m.pollutionGlobal) mod.pollutionGlobal+=m.pollutionGlobal;
        if(m.happinessGlobal) mod.happinessGlobal+=m.happinessGlobal;
        if(m.trafficGlobal) mod.trafficGlobal+=m.trafficGlobal;
      }
      return mod;
    }

    function simulateEconomyAndPopulation(){
      const policyMod=aggregatePolicyModifiers();
      let totalHousing=0,totalJobs=0,totalProd=0,totalPoll=0,totalMaint=0;
      let baseTaxRes=0,baseTaxCom=0,baseTaxInd=0;
      let powerUsage=0,waterUsage=0,trafficLoad=10;

      for(let y=0;y<MAP_HEIGHT;y++){
        for(let x=0;x<MAP_WIDTH;x++){
          const tile=state.map[y][x];
          const zone=ZONES[tile.zone] || ZONES.empty;
          const lf=1+tile.level*0.4;
          const lfJobs=1+tile.level*0.5;
          const lfProd=1+tile.level*0.6;
          const housing=zone.baseHousing*lf;
          const jobs=zone.baseJobs*lfJobs;
          let prod=zone.baseProduction*lfProd;
          let pollution=zone.basePollution+tile.level*2;
          if(zone.type==="industrial" && policyMod.industrialPollutionExtra){
            pollution+=policyMod.industrialPollutionExtra;
          }
          let maint=zone.maintenance*(1+tile.level*0.25);

          if(zone.type!=="none"){
            powerUsage+=(zone.type==="industrial"?9:zone.type==="commercial"?6:3)*lf;
            waterUsage+=(zone.type==="industrial"?7:zone.type==="commercial"?4:3)*lf;
            trafficLoad+=(zone.type==="industrial"?3:zone.type==="commercial"?2:1)*lf;
          }

          totalHousing+=housing;
          totalJobs+=jobs;
          totalProd+=prod;
          totalPoll+=pollution;
          totalMaint+=maint;

          const taxBase=(housing*0.4+jobs*1.2+prod*0.8)/10;
          if(zone.type==="residential") baseTaxRes+=taxBase;
          if(zone.type==="commercial")  baseTaxCom+=taxBase;
          if(zone.type==="industrial")  baseTaxInd+=taxBase;
        }
      }

      const prevPop=state.population;
      let targetPop=totalHousing*(0.9+rand()*0.2);
      targetPop*=clamp(state.happiness/75,0.5,1.4);

      const energyRatio=state.powerCapacity>0?clamp(state.powerCapacity/Math.max(powerUsage,1),0.4,1.3):0.5;
      const waterRatio=state.waterCapacity>0?clamp(state.waterCapacity/Math.max(waterUsage,1),0.4,1.3):0.5;
      const infraRatio=Math.min(energyRatio,waterRatio);
      targetPop*=infraRatio;

      trafficLoad+=(targetPop/800);
      const trafficImpact=clamp(1-(trafficLoad/120),0.4,1.1);
      targetPop*=trafficImpact;

      const newPop=prevPop+(targetPop-prevPop)*0.2;
      state.population=Math.max(0,newPop);

      const jobsAvail=totalJobs*0.95;
      const employed=Math.min(jobsAvail,state.population);
      const unemployed=Math.max(0,state.population-employed);
      const empRate=state.population>0?(employed/state.population)*100:0;
      state.employmentRate=empRate;
      state.unemployed=unemployed;

      const tr=state.taxes.residential/100;
      const tc=state.taxes.commercial/100;
      const ti=state.taxes.industrial/100;
      let taxIncome=baseTaxRes*tr+baseTaxCom*tc+baseTaxInd*ti;

      taxIncome*=policyMod.taxModGlobal||1.0;
      totalProd*=policyMod.productionModGlobal||1.0;
      if(policyMod.industrialProductionMod) totalProd*=policyMod.industrialProductionMod;
      if(policyMod.industrialTaxMod) taxIncome*=policyMod.industrialTaxMod;

      totalProd*=currentWeather.productionMod;

      totalMaint*=policyMod.maintenanceModGlobal||1.0;

      let policiesUpkeep=0;
      for(const id in POLICIES){
        if(!state.policiesActive[id]) continue;
        policiesUpkeep+=POLICIES[id].upkeep;
      }

      let infraUpkeep=0;
      for(const id in INFRASTRUCTURE){
        if(!state.infrastructureBuilt[id]) continue;
        infraUpkeep+=INFRASTRUCTURE[id].upkeep;
      }

      const maintenanceCost=totalMaint+policiesUpkeep+infraUpkeep;
      const productionIncome=totalProd*1.1;
      const totalIncome=taxIncome+productionIncome;
      const netIncome=totalIncome-maintenanceCost;

      state.money+=netIncome;
      state.environment+=totalPoll*0.03+(policyMod.pollutionGlobal||0);
      state.trafficLoad=trafficLoad+(policyMod.trafficGlobal||0);
      state.powerUsage=powerUsage;
      state.waterUsage=waterUsage;

      state.lastTurn.taxIncome=taxIncome;
      state.lastTurn.productionIncome=productionIncome;
      state.lastTurn.maintenanceCost=maintenanceCost;
      state.lastTurn.netIncome=netIncome;
      state.lastTurn.populationDelta=state.population-prevPop;
    }

    function simulateHappiness(){
      const policyMod=aggregatePolicyModifiers();
      let delta=0;
      const unempRate=state.population>0?(state.unemployed/state.population)*100:0;
      if(unempRate>10) delta-=(unempRate-10)*0.1;
      if(state.environment<-15) delta-=3;
      else if(state.environment<0) delta-=1;
      else if(state.environment>25) delta+=3;
      else if(state.environment>5) delta+=1;
      if(state.trafficLoad>70) delta-=4;
      else if(state.trafficLoad>40) delta-=2;
      if(state.powerUsage>state.powerCapacity) delta-=4;
      if(state.waterUsage>state.waterCapacity) delta-=4;
      delta+=currentWeather.moodDelta;
      delta+=policyMod.happinessGlobal||0;

      const avgTax=(state.taxes.residential+state.taxes.commercial+state.taxes.industrial)/3;
      if(avgTax>18) delta-=(avgTax-18)*0.2;
      else if(avgTax<8) delta+=(8-avgTax)*0.15;

      state.happiness=clamp(state.happiness+delta,0,100);
      state.lastTurn.happinessDelta=delta;
    }

    function rollWeather(){
      const dayInSeason=(state.day-1)%30;
      currentSeasonIndex=Math.floor((state.day-1)/30)%4;
      let candidates=[];
      if(SEASONS[currentSeasonIndex]==="Yaz"){
        candidates=["sunny","sunny","sunny","storm","drought","rain"];
      }else if(SEASONS[currentSeasonIndex]==="Kış"){
        candidates=["snow","snow","snow","sunny","storm","rain"];
      }else{
        candidates=["sunny","sunny","rain","rain","storm","snow"];
      }
      const chosenId=choice(candidates);
      currentWeather=WEATHER_TYPES.find(w=>w.id===chosenId)||WEATHER_TYPES[0];
      if(dayInSeason===0) addLog(`Yeni mevsim: ${SEASONS[currentSeasonIndex]}.`,"info");
      addLog(`Bugünün hava durumu: ${currentWeather.name}.`,"neutral");
    }

    function rollDisasters(){
      const policyMod=aggregatePolicyModifiers();
      DISASTERS.forEach(d=>{
        let chance=d.baseChance*currentWeather.disasterRiskMod;
        if(d.id==="fire" && policyMod.fireRiskMod) chance*=policyMod.fireRiskMod;
        if(d.id==="flood" && policyMod.floodRiskMod) chance*=policyMod.floodRiskMod;
        if(d.id==="epidemic" && policyMod.epidemicRiskMod) chance*=policyMod.epidemicRiskMod;
        chance*=1+state.population/6000;
        if(rand()<chance) applyDisaster(d);
      });
    }

    function applyDisaster(d){
      let msg=`${d.name} şehri vurdu! `;
      state.money-=d.moneyLoss;
      state.happiness=clamp(state.happiness+d.moodDelta,0,100);
      if(d.tilesHit>0){
        for(let i=0;i<d.tilesHit;i++){
          const x=randInt(0,MAP_WIDTH-1);
          const y=randInt(0,MAP_HEIGHT-1);
          const tile=state.map[y][x];
          if(tile.zone==="empty") continue;
          if(tile.level>0 && rand()<0.5){
            tile.level--;
            msg+=` ${String.fromCharCode(65+y)}${x+1} alanı hasar aldı (seviye düştü).`;
          }else{
            tile.zone="empty"; tile.level=0; tile.pollution=0;
            msg+=` ${String.fromCharCode(65+y)}${x+1} tamamen yıkıldı.`;
          }
        }
      }else{
        const loss=state.population*0.05;
        state.population=Math.max(0,state.population-loss);
        msg+=`Nüfus ${loss.toFixed(0)} kişi azaldı.`;
      }
      addLog(msg,"bad");
    }

    function endTurn(){
      state.day+=1;
      rollWeather();
      simulateEconomyAndPopulation();
      simulateHappiness();
      rollDisasters();
      applyInfrastructureStaticEffects();
      if(state.day%5===0){
        try{ localStorage.setItem(STORAGE_KEY,JSON.stringify(state)); }catch(e){ console.warn("Autosave fail",e); }
      }
      state.statsHistory.push({
        day:state.day,
        population:state.population,
        money:state.money,
        happiness:state.happiness,
        environment:state.environment
      });
      if(state.statsHistory.length>200) state.statsHistory.shift();
      renderAll();
    }

    function bindUI(){
      document.getElementById("btnEndTurn").addEventListener("click",endTurn);
      document.getElementById("btnNewGame").addEventListener("click",()=>{
        if(confirm("Yeni oyun başlatılsın mı? (Kaydedilmemiş ilerleme kaybolur)")){
          state=defaultState();
          selectedTile=null;
          currentWeather=WEATHER_TYPES[0];
          currentSeasonIndex=0;
          addLog("Yeni şehir kurulumuna başlandı.","info");
          renderAll();
        }
      });
      document.getElementById("btnSave").addEventListener("click",saveGame);
      document.getElementById("btnLoad").addEventListener("click",loadGame);
      document.getElementById("btnReset").addEventListener("click",()=>{
        if(confirm("Kayıtlı oyunu tamamen silmek istiyor musun?")){
          resetSave();
        }
      });
      document.getElementById("btnClearLog").addEventListener("click",()=>{
        logContainer().innerHTML="";
      });

      document.getElementById("taxResidential").addEventListener("input",e=>{
        state.taxes.residential=parseInt(e.target.value,10); renderStats();
      });
      document.getElementById("taxCommercial").addEventListener("input",e=>{
        state.taxes.commercial=parseInt(e.target.value,10); renderStats();
      });
      document.getElementById("taxIndustrial").addEventListener("input",e=>{
        state.taxes.industrial=parseInt(e.target.value,10); renderStats();
      });
    }

    function renderAll(){
      renderMap();
      renderTileDetails();
      renderStats();
      renderPolicies();
      renderInfrastructure();
    }

    function initGame(){
      state=defaultState();
      bindUI();
      applyInfrastructureStaticEffects();
      addLog("TextCity Master'a hoş geldin. Haritadan alan seçip bölge belirleyerek başla!","info");
      renderAll();
    }

    document.addEventListener("DOMContentLoaded",initGame);
  </script>
</body>
</html>
